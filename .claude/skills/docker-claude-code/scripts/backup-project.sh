#!/bin/bash
set -e

# ==========================================
# Docker Claude Code - Project Backup Script
# ==========================================
# 用途：将容器内的项目文件备份到宿主机
# 作者：Auto-generated by docker-claude-code skill
# ==========================================

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# 帮助信息
show_help() {
    echo "Usage: bash backup-project.sh [backup-directory]"
    echo ""
    echo "从 Docker 容器备份项目文件到宿主机"
    echo ""
    echo "参数说明:"
    echo "  backup-directory    备份目标目录（默认: ./backups/\$(date +%Y%m%d_%H%M%S))"
    echo ""
    echo "示例:"
    echo "  bash backup-project.sh"
    echo "  bash backup-project.sh ../my-backup"
    echo ""
    echo "注意："
    echo "  - 必须在包含 docker-compose.yml 的项目目录中运行"
    echo "  - 容器必须处于运行状态"
}

# 检查 docker-compose 是否存在
check_docker_compose() {
    if ! command -v docker-compose &> /dev/null; then
        echo -e "${RED}[✗]${NC} 未找到 docker-compose 命令"
        echo -e "${YELLOW}请先安装 docker-compose${NC}"
        exit 1
    fi

    # 检查 docker-compose.yml 文件是否存在
    if [ ! -f "docker-compose.yml" ]; then
        echo -e "${RED}[✗]${NC} 未找到 docker-compose.yml 文件"
        echo -e "${YELLOW}请在包含 docker-compose.yml 的项目目录中运行此脚本${NC}"
        exit 1
    fi
}

# 检查容器是否运行
check_container_running() {
    if ! docker-compose ps app | grep -q "Up"; then
        echo -e "${RED}[✗]${NC} 容器未运行"
        echo -e "${YELLOW}请先启动容器: docker-compose up -d${NC}"
        exit 1
    fi
}

# 创建备份目录
create_backup_dir() {
    local backup_dir=$1
    mkdir -p "$backup_dir"
    echo -e "${GREEN}✓${NC} 备份目录已创建: $backup_dir"
}

# 执行备份
do_backup() {
    local backup_dir=$1
    local container_name="docker-claude-code-app"

    echo -e "${BLUE}开始从容器备份...${NC}"
    echo -e "${CYAN}源位置:${NC} $container_name:/workspace/project/"
    echo -e "${CYAN}目标位置:${NC} $backup_dir/"
    echo ""

    # 检查容器内是否有文件
    FILE_COUNT=$(docker-compose exec -T app sh -c 'ls -1 /workspace/project/ 2>/dev/null | wc -l' || echo "0")
    if [ "$FILE_COUNT" -eq 0 ]; then
        echo -e "${YELLOW}[!]${NC} 容器内 /workspace/project/ 目录为空"
        echo -e "${YELLOW}备份将创建空目录${NC}"
    fi

    # 使用 docker cp 复制文件
    docker cp "$container_name:/workspace/project/." "$backup_dir/"

    if [ $? -eq 0 ]; then
        # 统计备份的文件数量
        BACKUP_COUNT=$(find "$backup_dir" -type f | wc -l)
        echo ""
        echo -e "${GREEN}[✓]${NC} 备份完成！"
        echo -e "${BLUE}备份信息:${NC}"
        echo -e "  ${CYAN}备份位置:${NC} $backup_dir"
        echo -e "  ${CYAN}文件数量:${NC} $BACKUP_COUNT 个文件"
        echo ""
        echo -e "${YELLOW}提示:${NC} 备份文件现在位于宿主机: $backup_dir"
    else
        echo -e "${RED}[✗]${NC} 备份失败！"
        exit 1
    fi
}

# 主函数
main() {
    echo -e "${BLUE}=== Docker Claude Code - 项目备份 ===${NC}"
    echo ""

    # 检查参数
    if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
        show_help
        exit 0
    fi

    # 设置备份目录
    local backup_dir
    if [ -z "$1" ]; then
        # 默认备份到带时间戳的目录
        backup_dir="./backups/$(date +%Y%m%d_%H%M%S)"
    else
        backup_dir="$1"
    fi

    # 执行检查
    check_docker_compose
    check_container_running

    # 创建备份目录
    create_backup_dir "$backup_dir"

    # 执行备份
    do_backup "$backup_dir"

    echo ""
    echo -e "${GREEN}=== 备份完成 ===${NC}"
}

# 执行主函数
main "$@"
