# Claude Code 使用指南

> **阅读时间**：10 分钟
> **核心理念**：Claude Code 是主动帮你写代码的 AI 助手，不是被动回答问题的聊天机器人

---

## 一、核心理念

### Claude Code 与聊天机器人的区别

| 聊天机器人 | Claude Code |
|-----------|-------------|
| 回答问题后等待 | 主动探索、规划、实现 |
| 你写代码，它审查 | 你描述目标，它构建代码 |
| 单次交互 | 持续会话，可追溯、可回滚 |

### 工作循环

```
你的提示 → 收集上下文 → 执行操作 → 验证结果 → 重复直到完成
```

**简单来说**：Claude 会像真实开发者一样工作——先理解项目，再动手操作，最后验证结果。

**三个阶段**：

| 阶段 | Claude 做什么 |
|------|---------------|
| **收集上下文** | 搜索文件、读取代码、理解项目结构 |
| **执行操作** | 编辑文件、运行命令、使用工具 |
| **验证结果** | 运行测试、检查输出、确认完成 |

**关键能力**：

| 类别 | 能做什么 |
|------|----------------|
| **文件操作** | 读取、编辑、创建、重命名文件 |
| **搜索** | 按模式找文件、搜索内容 |
| **执行** | 运行命令、测试、Git 操作 |
| **Web** | 搜索网页、获取文档 |
| **代码智能** | 类型错误检测、跳转定义（需 IDE 插件） |

### 核心约束

**记忆空间（Context Window）是最重要资源**

> **简单来说**：Claude 的"记忆"是有限的。当记忆快满时，性能会下降。需要合理管理记忆使用。

---

## 二、提示词技巧

### 提供验证方式

没有明确成功标准，Claude 可能产生"看起来对但实际错"的代码。

| ❌ 之前 | ✅ 之后 |
|-------|--------|
| "实现邮箱验证函数" | "编写 validateEmail 函数。测试用例：test@example.com → true，invalid → false。实现后运行测试" |
| "让 dashboard 更好看" | "[粘贴截图] 实现这个设计。截图对比结果，列出差异并修复" |
| "构建失败了" | "构建错误：[粘贴错误日志]。修复根本原因，验证构建成功" |

**验证方法**：
- 测试套件
- 代码检查（Lint）
- 截图对比
- 命令验证输出

### 提供具体上下文

Claude 能推断意图，但无法读心。引用具体文件、说明约束、指向示例模式。

| ❌ 模糊 | ✅ 具体 |
|-------|--------|
| "为 foo.py 添加测试" | "为 foo.py 编写测试，覆盖用户登出场景。避免使用 mocks" |
| "ExecutionFactory API 为什么这么奇怪" | "查看 ExecutionFactory 的 git 历史，总结 API 如何演变成现在这样" |
| "添加日历组件" | "参考首页现有组件（HotDogWidget.php）的模式实现日历组件，支持月份选择和前后翻页" |
| "修复登录 bug" | "用户报告会话超时后登录失败。检查 src/auth/ 认证流程，特别是 token 刷新。编写失败测试重现问题，然后修复" |

### 提供丰富内容

- **引用文件**：用 `@filename` 代替描述路径
- **粘贴图片**：直接拖放图片到提示词
- **提供 URL**：文档和 API 参考
- **管道数据**：`cat error.log | claude`
- **让 Claude 自取**：告诉 Claude 用工具获取上下文

---

## 三、环境配置

### CLAUDE.md 最佳实践

CLAUDE.md 是每次会话开始时读取的特殊文件，包含命令、代码风格、工作流规则。

#### 内容原则

| ✅ 包含 | ❌ 排除 |
|--------|--------|
| Claude 无法猜测的命令 | Claude 能从代码推断的内容 |
| 与默认不同的代码风格 | Claude 已知的标准语言约定 |
| 测试说明和首选测试运行器 | 详细的 API 文档（用链接替代） |
| 仓库规范（分支命名、PR 约定） | 频繁变化的信息 |
| 项目特定架构决策 | 长篇解释或教程 |
| 开发环境怪癖（必需环境变量） | "写干净代码"这种不言自明的实践 |

#### 精简原则

对每一行问：**删除这行会导致 Claude 犯错吗？** 如果不会，删除。

#### 文件位置

- `~/.claude/CLAUDE.md` - 全局（所有会话）
- `./CLAUDE.md` - 项目根目录（团队共享）
- `./CLAUDE.local.md` - 项目本地（加入 `.gitignore`）

### 权限配置

默认情况下，Claude Code 请求修改系统操作的权限。减少中断的方式：

- **权限白名单**：允许已知安全的工具（如 `npm run lint`、`git commit`）
- **沙箱模式**：启用 OS 级隔离，限制文件系统和网络访问
- **跳过权限**：`--dangerously-skip-permissions` 仅用于安全工作流

### CLI 工具

CLI 是与外部服务交互最高效的方式。

```bash
# GitHub 用户安装 gh CLI
# Claude 知道如何用 gh 创建 issue、打开 PR、阅读评论
```

Claude 擅长学习新 CLI：
```
Use 'foo-cli-tool --help' to learn about foo tool, then use it to solve A, B, C.
```

---

## 四、会话管理

### 核心命令

| 命令 | 作用 | 使用场景 |
|------|------|---------|
| `/clear` | 重置记忆 | 无关任务之间切换 |
| `/compact <指令>` | 压缩会话历史 | 会话过长时保留关键信息 |
| `/rewind` | 回滚到之前状态 | 恢复代码或会话 |
| `/context` | 查看记忆使用 | 监控空间占用 |
| `Esc` | 停止当前操作 | 中断执行 |
| `Esc + Esc` | 打开回滚菜单 | 选择恢复点 |
| `/rename "名称"` | 给会话命名 | 便于后续查找 |

### 会话类型

| 类型 | 说明 | 适用场景 |
|------|------|---------|
| **Resume** | 继续同一会话 | 继续刚才的工作 |
| **Fork** | 创建新会话分支 | 尝试不同方向 |

### 压缩最佳实践

```bash
# 手动压缩特定部分
/compact Focus on the API changes

# 从检查点压缩
Esc + Esc → 选择消息 → Summarize from here
```

**压缩时 Claude 会保留**：
- 代码模式和文件状态
- 关键架构决策
- 已修改文件列表

### 使用子代理

> **简单来说**：子代理是独立的 Claude 实例，有自己的记忆空间，不会污染主会话。

```bash
# 调查场景
Use subagents to investigate how our authentication system handles
token refresh, and whether we have any existing OAuth utilities.

# 验证场景
Use a subagent to review this code for edge cases.
```

### 检查点与回滚

Claude 在修改前自动创建检查点。

```bash
# 尝试风险操作，失败就回滚
/rewind  # 选择恢复：仅会话、仅代码、或两者
```

---

## 五、Plan Mode

### 用途

**只读分析模式**：安全探索代码库，创建可审批的计划

### 何时使用

- 多文件实现任务
- 深度代码探索
- 需要用户审批的架构决策

### 启动方式

```bash
# 会话中切换
Shift+Tab → accept edits on → plan mode on

# 新会话直接启动
claude --permission-mode plan

# 无头模式
claude --permission-mode plan -p "分析认证系统"
```

### 工作流程

```
1. 探索代码库（只读）
   ↓
2. 设计实现方案
   ↓
3. 用户审批计划
   ↓
4. 退出 Plan Mode 执行
```

---

## 六、扩展特性

### 特性概览

| 特性 | 何时使用 | 记忆成本 |
|------|---------|-----------|
| **CLAUDE.md** | 每次会话都需要的项目规范 | 高（每次请求） |
| **Skills** | 可重用知识、可调用工作流 | 低（描述）→ 使用时加载 |
| **Subagents** | 独立记忆空间、并行任务 | 隔离（独立记忆） |
| **Agent Teams** | 多会话协作、独立协调 | 高（每个独立实例） |
| **MCP** | 连接外部服务 | 中高（工具定义） |
| **Hooks** | 自动化脚本 | 零（外部运行） |

### 如何选择

| 需求 | 推荐方案 |
|------|---------|
| 项目规范 | CLAUDE.md |
| 可重用工作流 | Skills |
| 大量文件读取 | Subagents |
| 多会话协作 | Agent Teams |
| 连接外部服务 | MCP |
| 自动化脚本 | Hooks |

> **注**：对于零基础用户，先掌握 CLAUDE.md 和核心会话命令即可，其他特性可后续学习。

---

## 七、记忆空间管理

### 加载时机

| 特性 | 何时加载 |
|------|---------|
| **CLAUDE.md** | 会话开始，每次请求 |
| **Skills** | 描述在会话开始，完整内容在使用时 |
| **MCP** | 会话开始，所有工具定义 |
| **Subagents** | 按需，独立记忆空间 |
| **Hooks** | 触发时，零成本（外部运行） |

### 管理策略

```bash
# 检查记忆使用
/context
```

**实用建议**：

1. **CLAUDE.md 保持精简**
   - 只保留"每次会话都需要的规则"
   - 详细文档链接到 Skill

2. **大量文件读取用 Subagent**
   - 避免主会话记忆污染
   - 返回摘要而非全部内容

3. **定期压缩会话**
   - 使用 `/compact` 保留关键信息
   - 无关任务之间使用 `/clear`

4. **使用 `/context` 监控**
   - 检查记忆使用百分比
   - 接近满载时及时清理

---

## 八、自动化扩展

### 无头模式

```bash
# 一次性查询
claude -p "解释这个项目做什么"

# 结构化输出（脚本解析）
claude -p "列出所有 API 端点" --output-format json

# 流式输出（实时处理）
claude -p "分析这个日志文件" --output-format stream-json
```

**用途**：CI 管道、pre-commit hooks、自动化工作流。

### 多会话协作

| 方式 | 说明 |
|------|------|
| **Desktop App** | 可视化管理多个本地会话 |
| **Web 版** | 安全云端 VM 隔离环境 |
| **Agent Teams** | 自动协调多会话，共享任务和消息 |

### Writer/Reviewer 模式

| Session A (Writer) | Session B (Reviewer) |
|--------------------|---------------------|
| 实现速率限制器 | 审查实现：边界情况、竞态条件、与现有中间件模式一致性 |
| 根据审查反馈修改 | |

> **简单来说**：一个 Claude 负责写代码，另一个负责审查代码，就像真实开发团队的 Code Review 流程。

### 安全自主模式

```bash
claude --dangerously-skip-permissions
```

跳过所有权限检查，**仅用于**安全工作流（修复 lint 错误、生成样板代码）。

---

## 九、常见陷阱

### 1. 大杂烩会话

**问题**：开始一个任务，切换无关任务，再回到第一个任务。记忆充满无关信息。

**解决**：无关任务之间用 `/clear`

### 2. 反复修正

**问题**：Claude 做错，你修正，还错，再修正。记忆被失败方法污染。

**解决**：**超过 2 次修正后，`/clear` 并用更好的初始提示重启**

### 3. 过度指定的 CLAUDE.md

**问题**：文件太长，Claude 忽略一半内容，重要规则被淹没。

**解决**：无情删减。已正确执行的指令 → 删除或转为 hook

### 4. 信任但无验证

**问题**：Claude 产出看似合理的实现，但不处理边界情况。

**解决**：**始终提供验证（测试、脚本、截图）。无法验证就不要交付**

### 5. 无限探索

**问题**：要求 Claude "调查"某事但不限定范围。Claude 读取数百文件，填满记忆。

**解决**：**缩小调查范围或使用子代理**

---

## 十、快速参考

### 提示词对比

| ❌ 差 | ✅ 好 |
|------|------|
| "修复 bug" | "用户报告登录失败。检查 src/auth/，编写失败测试，修复根本原因" |
| "添加测试" | "为 foo.py 添加测试，覆盖登出场景。避免 mocks" |

### CLAUDE.md 检查清单

- [ ] 每个命令都是 Claude 无法猜测的
- [ ] 只包含与默认不同的代码风格
- [ ] 链接替代详细文档
- [ ] 删除任何 Claude 已正确执行的内容

### 会话命令速查

```bash
/clear                          # 重置会话
/compact Focus on X             # 压缩会话
/rewind                         # 回滚菜单
/context                        # 查看记忆使用
/rename "名称"                  # 给会话命名
```

---

## 相关文档

| 文档 | 内容 |
|------|------|
| **claude-code-guide.md**（本文档） | 完整使用指南 |
| **spec-workflow-tutorial.md** | Spec Workflow 工具教程 |

---

**培养直觉**：这些模式是起点，非教条。观察什么有效，调整策略。你将发展出任何指南无法捕获的直觉。
